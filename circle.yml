machine:
  hosts:
    postgres: 127.0.0.1
  pre:
    - sudo curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
  environment:
    AWS_DEFAULT_REGION: "us-east-1"
    SBT_VERSION: "0.13.13"
    SBT_OPTS: "-Xms512M -Xmx1536M -Xss1M -XX:+CMSClassUnloadingEnabled"
    GPROJECT_NAME: "geladinha"
    PROJECT_NAME: "api"
    CLUSTER_NAME: "api-cluster"
    CLOUDSDK_COMPUTE_ZONE: "us-east1-d"
    COVERALLS_REPO_TOKEN: ${COVERALLS_REPO_TOKEN}
    COVERALLS_SERVICE_JOB_ID: ${CIRCLE_BUILD_NUM}
    COVERALLS_SERVICE_NAME: CircleCI
    TRAVIS_JOB_ID: ${CIRCLE_BUILD_NUM}
dependencies:
  cache_directories:
    - "~/.m2"
    - "~/.ivy2"
    - "~/.sbt"
  override:
    - make test/compile
test:
  override:
    - sudo service postgresql stop
    - while sudo lsof -Pi :5432 -sTCP:LISTEN -t; do sleep 1; done
    - make test
    - make test/coveralls
